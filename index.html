<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#02529B">

<!-- iOS install friendliness -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shots-On-Goal Tracker</title>
<style>
  :root{
    --brand:#02529B; --brand2:#5272B3; --hl:#FFC526; --bg:#F6F8FB; --card:#fff; --muted:#EAF0FB;
    --text:#111827; --mutedText:#6b7280; --onbrand:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:720px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 6px 24px rgba(2,82,155,.08);padding:16px}
  h1{margin:0;text-align:center;color:var(--brand);font-size:20px;font-weight:800}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .col{flex:1;min-width:0}
  label{font-size:12px;color:var(--mutedText);display:block;margin-bottom:4px}
  input,select,button{font-size:16px}
  input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .btn{border:none;border-radius:16px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{background:#d1d5db;color:#6b7280;cursor:not-allowed}
  .btn-primary{background:var(--brand);color:var(--onbrand)}
  .btn-secondary{background:var(--brand2);color:var(--onbrand)}
  .btn-ghost{background:#eef2f7}
  .btn-hl{background:var(--hl);color:#111}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .status{display:flex;gap:8px;margin-top:8px}
  .chip{background:var(--muted);border-radius:12px;padding:8px 10px;min-width:0;flex:1}
  .chip .lab{font-size:11px;color:var(--mutedText);line-height:1}
  .chip .val{font-weight:800;color:var(--brand);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:var(--muted);font-weight:700;text-align:left;padding:8px 6px;font-size:13px}
  tbody td{padding:8px 6px;font-size:14px}
  tbody tr:nth-child(even){background:#f9fafb}
  .logo-wrap{display:flex;justify-content:center;margin-top:4px;margin-bottom:8px}
  .logo{max-height:90px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.08))}
  .full{width:100%}
  .hidden{display:none !important}
  .center{text-align:center}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .pb12{padding-bottom:12px}
  .version{position:absolute;right:12px;bottom:8px;color:#9ca3af;font-size:11px;user-select:none}
  /* Make only Save and Goal buttons taller */
#btnSave, #btnGoal {
  min-height: 120px;   /* about double height */
  font-size: 22px;     /* larger text for visibility */
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="card">
    <h1>Shots-On-Goal Tracker</h1>
    <div id="status" class="status hidden">
      <div class="chip"><div class="lab">Current Period</div><div class="val" id="stPeriod">P1</div></div>
      <div class="chip"><div class="lab">Current Team</div><div class="val" id="stTeam">Home</div></div>
      <div class="chip"><div class="lab">Current Goalie #</div><div class="val" id="stGoalie">—</div></div>
    </div>
  </div>

  <!-- Start Screen -->
  <div id="startCard" class="card" style="position:relative;padding-bottom:36px">
    <div class="logo-wrap">
      <img src="Hounds Logo - no back.avif" alt="Team Logo" class="logo" onerror="this.style.display='none'"/>
    </div>
    <div class="row mt8">
      <div class="col" style="max-width:160px">
        <label>Period length (minutes)</label>
        <input id="periodLen" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 15" value="15"/>
      </div>
    </div>
    <div class="row mt8">
      <div class="col" style="max-width:220px">
        <label>Team in Goal for Period 1</label>
        <select id="initialTeam">
          <option>Home</option>
          <option>Away</option>
        </select>
      </div>
    </div>
<div class="row mt8" style="align-items:center;gap:6px;font-size:14px">
  <input id="haptics" type="checkbox" style="margin:0"/>
  <label for="haptics" style="cursor:pointer">Haptics (Android users only)</label>
</div>
    <button id="btnStartGame" class="btn btn-primary full mt12">Start Game</button>
    <div id="version" class="version"></div>
  </div>

  <!-- Start-of-period setup -->
  <div id="periodSetup" class="card hidden">
    <div>
      <label>Goalie # Starting Period</label>
      <input id="startGoalie" placeholder="e.g. 31"/>
    </div>
    <button id="btnStartPeriod" class="btn btn-secondary full mt12">Start Period</button>
  </div>

  <!-- Live Tally -->
  <div class="card">
    <div style="font-weight:700;color:var(--brand);margin-bottom:6px">Live Tally</div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Team</th>
            <th>Goalie #</th>
            <th class="center">P1 (S/G)</th>
            <th class="center">P2 (S/G)</th>
            <th class="center">P3 (S/G)</th>
            <th class="center">Total Ice</th>
          </tr>
        </thead>
        <tbody id="tallyBody">
          <tr id="noDataRow"><td colspan="6" style="color:#6b7280;padding:14px 6px">No data yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Shot buttons -->
  <div class="card">
    <div class="grid2">
      <button id="btnSave" class="btn btn-primary" disabled>Save</button>
      <button id="btnGoal" class="btn btn-hl" disabled>Goal</button>
    </div>
  </div>

  <!-- Switch Goalie + Next Period / End Game -->
  <div class="card">
    <button id="toggleSwitch" class="btn btn-secondary full">Switch Goalie</button>
    <div id="switchPanel" class="hidden mt12">
      <div class="row">
        <div class="col">
          <label>New goalie #</label>
          <input id="newGoalie"/>
        </div>
        <div class="col">
          <label>Game Clock Time (MM:SS)</label>
          <input id="switchClock" placeholder="14:23"/>
        </div>
      </div>
      <button id="btnConfirmSwitch" class="btn btn-primary full mt12">Confirm Switch</button>
    </div>
    <button id="btnPeriodOrEnd" class="btn btn-secondary full mt12">Next Period</button>
  </div>

  <!-- Undo -->
  <div class="card">
    <button id="btnUndo" class="btn btn-ghost full">Undo</button>
  </div>

  <!-- Reset -->
  <div class="card">
    <button id="btnReset" class="btn btn-ghost full">Reset</button>
  </div>
  <div id="versionBadge"
     style="position:fixed;right:8px;bottom:4px;font-size:11px;color:#9ca3af;user-select:none;pointer-events:none;z-index:9999">
</div>
</div>

<script>
/* ---------------- Version: auto-increment on code changes ---------------- */
(function(){
  const SEMVER_BASE = "v2.2.4";
  function hashString(str){
    let h = 5381;
    for (let i = 0; i < str.length; i++) h = ((h << 5) + h) + str.charCodeAt(i);
    return (h >>> 0).toString(36);
  }

  // ✅ Hash the current inline script (i.e., your app code)
  // This guarantees the hash changes whenever you edit the file.
  var CURRENT_SCRIPT = document.currentScript;
  // If this block isn’t the last script, try to find the last inline one:
  if (!CURRENT_SCRIPT) {
    const scripts = Array.from(document.scripts).filter(s => s.src === "");
    CURRENT_SCRIPT = scripts[scripts.length - 1] || null;
  }
  const CODE_TEXT = CURRENT_SCRIPT ? CURRENT_SCRIPT.textContent : "";
  const CODE_HASH = hashString(CODE_TEXT);

  const LS_BUILD_KEY = "sogt_build_off";
  const LS_HASH_KEY  = "sogt_code_hash_off";

  let build = parseInt(localStorage.getItem(LS_BUILD_KEY) || "0", 10) || 0;
  const prev = localStorage.getItem(LS_HASH_KEY);

  if (prev !== CODE_HASH) {
    build += 1;
    localStorage.setItem(LS_BUILD_KEY, String(build));
    localStorage.setItem(LS_HASH_KEY, CODE_HASH);
  }

  // Expose a friendly version string and render badges if present
  window.APP_VERSION = `${SEMVER_BASE} • build ${build}`;

  // Start screen (small, absolute)
  const v1 = document.getElementById('version');
  if (v1) v1.textContent = window.APP_VERSION;

  // Persistent bottom-right badge
  const v2 = document.getElementById('versionBadge');
  if (v2) v2.textContent = window.APP_VERSION;
})();

/* ---------------- Utilities ---------------- */
const pad = n => (n<10?`0${n}`:`${n}`);
const mmssToSec = mmss => {
  const [m,s]=(String(mmss||"0:00").split(":")).map(x=>parseInt(x||0,10));
  if(isNaN(m)||isNaN(s)) return 0;
  return Math.max(0,m*60+s);
};
const secToMMSS = sec => {
  const s=Math.max(0,Math.floor(sec)); const m=Math.floor(s/60); const r=s%60;
  return `${m}:${pad(r)}`;
};

/* ---------------- State ---------------- */
let periodLenMin = 15;
let haptics = false;

let gameStarted = false;
let period = 1;
let team = "Home";
let activeGoalie = "";
let periodHasStarted = false;
let shiftStartClock = "15:00";

const shots = [];    // {team, goalie, period, result}
const shifts = [];   // {team, goalie, period, timeOn, timeOff}
const seeded = [];   // {team, goalie} to show row with zeros
const actions = [];  // undo stack

/* ---------------- DOM Helpers ---------------- */
const el = id => document.getElementById(id);
const $startCard = el('startCard');
const $status = el('status');
const $stPeriod = el('stPeriod');
const $stTeam = el('stTeam');
const $stGoalie = el('stGoalie');

const $periodSetup = el('periodSetup');
const $periodLen = el('periodLen');
const $initialTeam = el('initialTeam');
const $haptics = el('haptics');

const $startGoalie = el('startGoalie');
const $btnStartGame = el('btnStartGame');
const $btnStartPeriod = el('btnStartPeriod');

const $btnSave = el('btnSave');
const $btnGoal = el('btnGoal');

const $toggleSwitch = el('toggleSwitch');
const $switchPanel = el('switchPanel');
const $newGoalie = el('newGoalie');
const $switchClock = el('switchClock');
const $btnConfirmSwitch = el('btnConfirmSwitch');

const $btnPeriodOrEnd = el('btnPeriodOrEnd');
const $btnUndo = el('btnUndo');
const $btnReset = el('btnReset');

const $tallyBody = el('tallyBody');
const $noDataRow = el('noDataRow');

/* ---------------- Haptics ---------------- */
function vibrate(kind){
  if(!haptics) return;
  try{
    if(!('vibrate' in navigator)) return;
    if(kind==='save') navigator.vibrate(12);
    else if(kind==='goal') navigator.vibrate([35,25,35]);
  }catch(e){}
}

/* ---------------- Rendering ---------------- */
function renderStatus(){
  if(!gameStarted){ $status.classList.add('hidden'); return; }
  $status.classList.remove('hidden');
  $stPeriod.textContent = `P${period}`;
  $stTeam.textContent = team;
  $stGoalie.textContent = activeGoalie || '—';
}

function buildStats(){
  // key = team|goalie
  const map = new Map();
  const base=()=>({shots:0,goals:0});
  const perBase=()=>({P1:base(),P2:base(),P3:base()});
  function ensure(t,g){
    const key=`${t}|${g}`;
    if(!map.has(key)) map.set(key,{team:t,goalie:g,per:perBase(),iceSec:0});
    return map.get(key);
  }
  // seeded
  for(const s of seeded) ensure(s.team,s.goalie);
  // shots
  for(const s of shots){
    const rec=ensure(s.team,s.goalie);
    const k=s.period===1?'P1':s.period===2?'P2':'P3';
    rec.per[k].shots+=1;
    if(s.result==='Goal') rec.per[k].goals+=1;
  }
  // shifts (timeOn > timeOff because clock counts down)
  for(const sh of shifts){
    const rec=ensure(sh.team,sh.goalie);
    rec.iceSec += Math.max(0, mmssToSec(sh.timeOn)-mmssToSec(sh.timeOff));
  }
  return map;
}

function renderTally(){
  const map = buildStats();
  $tallyBody.innerHTML = '';
  if(map.size===0){
    $tallyBody.appendChild($noDataRow);
    return;
  }
  for(const rec of map.values()){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${rec.team}</td>
      <td style="font-weight:700">${rec.goalie}</td>
      <td class="center">${rec.per.P1.shots}/${rec.per.P1.goals}</td>
      <td class="center">${rec.per.P2.shots}/${rec.per.P2.goals}</td>
      <td class="center">${rec.per.P3.shots}/${rec.per.P3.goals}</td>
      <td class="center">${secToMMSS(rec.iceSec)}</td>
    `;
    $tallyBody.appendChild(tr);
  }
}

function setShotButtonsEnabled(on){
  $btnSave.disabled = !on;
  $btnGoal.disabled = !on;
}

/* ---------------- Seed helpers ---------------- */
function seedGoalieIfNeeded(goalie, t){
  if(!goalie) return;
  if(seeded.some(x=>x.goalie===goalie && x.team===t)) return;
  seeded.push({team:t, goalie:String(goalie)});
}

/* ---------------- Actions ---------------- */
function startGame(){
  // period length
  const v = ($periodLen.value||'').trim();
  if(!/^\d+$/.test(v)){ alert('Enter a valid period length (minutes).'); return; }
  periodLenMin = Math.max(1, parseInt(v,10));
  haptics = !!$haptics.checked;
  gameStarted = true;
  period = 1;
  team = $initialTeam.value === 'Away' ? 'Away' : 'Home';
  activeGoalie = '';
  periodHasStarted = false;
  shiftStartClock = `${periodLenMin}:${pad(0)}`;

  // clear game data
  shots.length = 0;
  shifts.length = 0;
  seeded.length = 0;
  actions.length = 0;

  // UI
  $startCard.classList.add('hidden');
  $periodSetup.classList.remove('hidden');
  setShotButtonsEnabled(false);
  $btnPeriodOrEnd.textContent = 'Next Period';
  renderStatus(); renderTally();

  actions.push({type:'startGame'});
}

function startPeriod(){
  const g = String(($startGoalie.value||'').trim());
  if(!g){ alert('Enter the goalie # starting the period'); return; }
  activeGoalie = g;
  periodHasStarted = true;
  shiftStartClock = `${periodLenMin}:${pad(0)}`;
  seedGoalieIfNeeded(g, team);

  $periodSetup.classList.add('hidden');
  setShotButtonsEnabled(true);
  renderStatus(); renderTally();

  actions.push({type:'periodStart', payload:{goalie:g}});
  // clear input for next period
  $startGoalie.value='';
}

function recordShot(result){
  if(!periodHasStarted || !activeGoalie) return;
  if(result==='Save') vibrate('save'); else vibrate('goal');
  const rec={team,goalie:String(activeGoalie),period,result};
  shots.push(rec);
  actions.push({type:'shot', payload:rec});
  renderTally();
}

function toggleSwitchPanel(){
  $switchPanel.classList.toggle('hidden');
}

function confirmSwitch(){
  if(!periodHasStarted || !activeGoalie) return;
  const newG = String(($newGoalie.value||'').trim());
  const clk = String(($switchClock.value||'').trim());
  if(!newG || !/^\d+$/.test(newG)){ alert('Enter the new goalie #'); return; }
  if(!/^\d{1,2}:\d{2}$/.test(clk)){ alert('Enter the game clock time as MM:SS'); return; }

  // close outgoing shift
  const outgoing = {team, goalie:String(activeGoalie), period, timeOn:shiftStartClock, timeOff:clk};
  shifts.push(outgoing);

  // switch
  const prevGoalie = activeGoalie;
  const prevShiftStart = shiftStartClock;
  activeGoalie = newG;
  shiftStartClock = clk;
  seedGoalieIfNeeded(newG, team);

  // clear UI fields + collapse
  $newGoalie.value=''; $switchClock.value='';
  $switchPanel.classList.add('hidden');

  actions.push({type:'switch', payload:{outgoingShift:outgoing, prevGoalie, prevShiftStart}});

  renderStatus(); renderTally();
}

function nextPeriod(){
  if(period>=3){ endGame(); return; }

  let closed=null;
  if(periodHasStarted && activeGoalie){
    closed = {team, goalie:String(activeGoalie), period, timeOn:shiftStartClock, timeOff:"00:00"};
    shifts.push(closed);
  }

  const snapshot = {
    prevPeriod: period, prevTeam: team, prevGoalie: activeGoalie,
    prevShiftStart: shiftStartClock, prevPeriodHasStarted: periodHasStarted, closed
  };
  actions.push({type:'startPeriod', payload:snapshot});

  // advance
  period += 1;
  team = (team==='Home' ? 'Away' : 'Home');
  activeGoalie = '';
  periodHasStarted = false;
  shiftStartClock = `${periodLenMin}:${pad(0)}`;

  // UI
  $periodSetup.classList.remove('hidden');
  setShotButtonsEnabled(false);
  if(period>=3) $btnPeriodOrEnd.textContent='End Game';
  renderStatus(); renderTally();
}
function closeOpenShiftAt(periodEndClock){
  // If a goalie is active in the current period, close their segment to the specified clock.
  if(periodHasStarted && activeGoalie){
    const seg = {
      team,
      goalie: String(activeGoalie),
      period,
      timeOn: shiftStartClock,       // when this goalie came on (countdown clock)
      timeOff: periodEndClock || "00:00" // where we’re closing to
    };
    shifts.push(seg);
    return seg; // return what we added so Undo can remove it cleanly if needed
  }
  return null;
}

function endGame(){
  if(!confirm("End the game and close the final shift at 00:00?")) return;

  // Always close any open shift to 00:00 so the last segment counts
  const closed = closeOpenShiftAt("00:00");

  actions.push({type:'endGame', payload:{closed}});

  renderTally(); // reflect the added ice time immediately

  alert("Game Ended. Please take this phone to the team manager and don't hit Reset or refresh the page. Thanks for helping!");
  gameEnded = true;
  setShotButtonsEnabled(false);
  $btnPeriodOrEnd.disabled = true;
  $toggleSwitch.disabled = true;
  $btnConfirmSwitch.disabled = true;
  $btnUndo.disabled = true;
}

function undo(){
  if(actions.length===0) return;
  const last = actions[actions.length-1];

  if(last.type==='shot'){
    shots.pop();
  } else if(last.type==='switch'){
    shifts.pop();
    activeGoalie = last.payload.prevGoalie;
    shiftStartClock = last.payload.prevShiftStart;
  } else if(last.type==='startPeriod'){
    if(last.payload.closed) shifts.pop();
    period = last.payload.prevPeriod;
    team = last.payload.prevTeam;
    activeGoalie = last.payload.prevGoalie;
    shiftStartClock = last.payload.prevShiftStart;
    periodHasStarted = last.payload.prevPeriodHasStarted;
    if(!periodHasStarted) $periodSetup.classList.remove('hidden');
    setShotButtonsEnabled(!!periodHasStarted);
    $btnPeriodOrEnd.textContent = (period>=3 ? 'End Game' : 'Next Period');
  } else if(last.type==='periodStart'){
    activeGoalie = '';
    shiftStartClock = `${periodLenMin}:${pad(0)}`;
    periodHasStarted = false;
    $periodSetup.classList.remove('hidden');
    $startGoalie.value = last.payload.goalie;
    setShotButtonsEnabled(false);
  } else if(last.type==='endGame'){
    // Remove the auto-closed segment we just added, if any
    if(last.payload && last.payload.closed) shifts.pop();
  }
  actions.pop();
  renderStatus(); renderTally();
}

function resetAll(){
  if(!confirm('Reset everything and clear all tallies?')) return;
  // restore defaults
  periodLenMin = 20; haptics = false;
  gameStarted=false; period=1; team='Home'; activeGoalie=''; periodHasStarted=false; shiftStartClock="20:00";
  shots.length=0; shifts.length=0; seeded.length=0; actions.length=0;

  gameEnded = false;
  $btnPeriodOrEnd.disabled = false;
  $toggleSwitch.disabled = false;
  $btnConfirmSwitch.disabled = false;
  $btnUndo.disabled = false;
  
  // UI
  $periodLen.value='20';
  $initialTeam.value='Home';
  $haptics.checked=false;
  $startCard.classList.remove('hidden');
  $periodSetup.classList.add('hidden');
  setShotButtonsEnabled(false);
  $btnPeriodOrEnd.textContent = 'Next Period';
  $switchPanel.classList.add('hidden');
  $newGoalie.value=''; $switchClock.value=''; $startGoalie.value='';
  renderStatus(); renderTally();
}

/* ---------------- Events ---------------- */
$btnStartGame.addEventListener('click', startGame);
$btnStartPeriod.addEventListener('click', startPeriod);
$btnSave.addEventListener('click', ()=>recordShot('Save'));
$btnGoal.addEventListener('click', ()=>recordShot('Goal'));

$toggleSwitch.addEventListener('click', toggleSwitchPanel);
$btnConfirmSwitch.addEventListener('click', confirmSwitch);

$btnPeriodOrEnd.addEventListener('click', ()=> (period<3 ? nextPeriod() : endGame()));
$btnUndo.addEventListener('click', undo);
$btnReset.addEventListener('click', resetAll);

// keep numeric-only typing feel on mobile for period length
$periodLen.addEventListener('input', (e)=>{
  const v=e.target.value;
  if(!/^\d*$/.test(v)) e.target.value = v.replace(/\D+/g,'');
});

/* ---------------- Initial render ---------------- */
renderStatus(); renderTally();
  
document.getElementById('versionBadge').textContent =`${SEMVER_BASE} • build ${build}`;
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Use your existing global APP_BUILD from the version badge logic
    const v = (window.APP_BUILD != null) ? String(window.APP_BUILD) : 'dev';
    navigator.serviceWorker.register(`service-worker.js?v=${encodeURIComponent(v)}`, { scope: './' })
      .catch(console.error);
  });
}
</script>

</body>
</html>